#!/bin/sh
### BEGIN INIT INFO
# Provides:          serial-symlinks
# Required-Start:    $local_fs
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Persistent symlinks using stable USB controller paths
# Description:       Uses hardware identifiers fcc00000.dwc3 (Voice) and fd8c0000.usb (Zigbee)
#                    to reliably distinguish two identical CH340 devices.
### END INIT INFO

RULES_FILE="/etc/udev/rules.d/99-smart-home.rules"

do_start() {
    echo "Setting up symlinks using stable USB controller hardware paths..."

    # 使用 DEVPATH 中的硬件控制器地址（永久不变）
    cat > "$RULES_FILE" <<'EOF'
# Voice Module - tied to USB controller fcc00000.dwc3 (XHCI, high-speed)
KERNEL=="ttyUSB*", DEVPATH=="*fcc00000.dwc3*", SYMLINK+="voice_module", MODE="0666"

# Zigbee Coordinator - tied to USB controller fd8c0000.usb (OHCI/EHCI)
KERNEL=="ttyUSB*", DEVPATH=="*fd8c0000.usb*", SYMLINK+="zigbee_module", MODE="0666"
EOF

    # 清理可能残留的旧符号链接
    rm -f /dev/zigbee_module /dev/voice_module

    if command -v udevadm >/dev/null 2>&1; then
        udevadm control --reload-rules
        udevadm trigger
        echo "✅ Rules applied. Symlinks are now hardware-bound and persistent."
    else
        echo "⚠️ Warning: udevadm not found. Rules written but not loaded." >&2
    fi
}

case "$1" in
    start)
        do_start
        ;;
    restart|reload|force-reload)
        do_start
        ;;
    stop|status)
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}" >&2
        exit 1
        ;;
esac

exit 0