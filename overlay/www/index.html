<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å®¶åº­æ™ºèƒ½ç»ˆç«¯</title>
  <link rel="stylesheet" href="/assets/style.css">
  <!-- é˜²æ­¢æœªç™»å½•ç”¨æˆ·çœ‹åˆ°é¡µé¢å†…å®¹ -->
  <style>
    #auth-guard {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #0a0a0a;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 18px;
    }
    /* åˆå§‹éšè—çœŸå®å†…å®¹ */
    #app-content { display: none; }
  </style>
</head>
<body>
  <!-- ğŸ”’ è®¤è¯é®ç½©ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
  <div id="auth-guard">
    éªŒè¯ç™»å½•ä¸­ï¼Œè¯·ç¨å€™...
  </div>

  <!-- ğŸ–¼ï¸ çœŸå®é¡µé¢å†…å®¹ï¼ˆåˆå§‹éšè—ï¼‰ -->
  <div id="app-content">
    <div class="bg"></div>
    <div class="overlay"></div>
    <canvas id="particles"></canvas>

    <div class="container">
      <div class="time" id="time">--:--</div>
      <div class="temp" id="temperature">ğŸŒ¡ï¸ å®¤æ¸©ï¼š23Â°C</div>
      
      <!-- âœ… ä¿®æ”¹ï¼šåŠ¨æ€å¤©æ°”è¡Œ -->
      <div class="weather" id="weather">
        <span id="weather-icon" class="weather-icon">ğŸŒ¤ï¸</span>
        <span id="weather-text">åŠ è½½ä¸­...</span>
      </div>
      
      <!-- 6ä¸ªåŠŸèƒ½å…¥å£ -->
      <div class="buttons">
        <a href="/disk.html" class="btn">ğŸ“ ç§äººç½‘ç›˜</a>
        <a href="/control.html" class="btn">ğŸ’¡ å®¶å±…æ§åˆ¶</a>
        <a href="/notes.html" class="btn">ğŸ“… å®¶åº­å¤‡å¿˜å½•</a>
        <a href="/photos.html" class="btn">ğŸ“¸ å®¶åº­ç›¸å†Œ</a>
        <a href="/system.html" class="btn">ğŸ–¥ï¸ ç³»ç»Ÿæ•°æ®</a>
        <a href="/test.html" class="btn">ğŸ§ª Test</a>
      </div>
    </div>
  </div>

  <!-- ğŸ” ç™»å½•çŠ¶æ€æ£€æµ‹ï¼ˆå…³é”®ï¼šæ”¾åœ¨å†…å®¹ä¹‹åã€åŠ¨ç”»ä¹‹å‰ï¼‰ -->
  <script>
    (async () => {
      try {
        const res = await fetch('/home/check-auth');
        if (res.status === 401) {
          window.location.replace('/login.html');
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch (e) {
          data = {};
        }

        if (data.error && data.error.includes('Unauthorized')) {
          window.location.replace('/login.html');
          return;
        }

        document.getElementById('auth-guard').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';

        // âœ… è®¤è¯æˆåŠŸåï¼Œå¯åŠ¨å¤©æ°”è½®è¯¢
        fetchAndRenderWeather(); // ç«‹å³è·å–
        setInterval(fetchAndRenderWeather, 5 * 60 * 1000); // æ¯5åˆ†é’Ÿ

      } catch (err) {
        window.location.replace('/login.html');
      }
    })();
  </script>

  <!-- â±ï¸ æ—¶é—´ & ğŸŒŸ ç²’å­åŠ¨ç”»ï¼ˆä»…åœ¨è®¤è¯åæ‰§è¡Œï¼‰ -->
  <script>
    // å¤©æ°”å›¾æ ‡æ˜ å°„ï¼ˆæ ¹æ® QWeather çš„ text å­—æ®µï¼‰
    const WEATHER_ICONS = {
      'æ™´': 'â˜€ï¸',
      'å¤šäº‘': 'â›…',
      'é˜´': 'â˜ï¸',
      'é›¾': 'ğŸŒ«ï¸',
      'å°é›¨': 'ğŸŒ¦ï¸',
      'ä¸­é›¨': 'ğŸŒ§ï¸',
      'å¤§é›¨': 'â›ˆï¸',
      'æš´é›¨': 'â›ˆï¸',
      'å°é›ª': 'ğŸŒ¨ï¸',
      'ä¸­é›ª': 'â„ï¸',
      'å¤§é›ª': 'â„ï¸',
      'æ‰¬æ²™': 'ğŸ’¨',
      'æµ®å°˜': 'ğŸ’¨',
      'æ²™å°˜æš´': 'ğŸŒªï¸',
      'å¼ºæ²™å°˜æš´': 'ğŸŒªï¸',
      'é›·é˜µé›¨': 'âš¡',
      'é›¨å¤¹é›ª': 'â˜”',
      'é˜µé›¨': 'ğŸŒ¦ï¸',
      'é˜µé›ª': 'â„ï¸'
    };

    function getWeatherIcon(text) {
      return WEATHER_ICONS[text] || 'ğŸŒ¤ï¸';
    }

    async function fetchAndRenderWeather() {
      const weatherTextEl = document.getElementById('weather-text');
      const weatherIconEl = document.getElementById('weather-icon');

      try {
        const res = await fetch('/home/weather');
        if (!res.ok) throw new Error('Network error');

        const data = await res.json();

        if (data.code !== '200') {
          weatherTextEl.textContent = 'å¤©æ°”æ•°æ®å¼‚å¸¸';
          weatherIconEl.textContent = 'âš ï¸';
          return;
        }

        const weather = data.weather || 'æœªçŸ¥';
        const temp = data.temperature || '--';
        const humidity = data.humidity || '--';
        const feelsLike = data.feels_like || '--';
        const windDir = data.wind_dir || '';
        const windScale = data.wind_scale ? `${data.wind_scale}çº§` : '';

        let desc = `${weather} Â· ${temp}Â°C`;
        if (feelsLike !== '--') desc += ` Â· ä½“æ„Ÿ${feelsLike}Â°C`;
        if (humidity !== '--') desc += ` Â· æ¹¿åº¦${humidity}%`;
        if (windDir || windScale) desc += ` Â· ${windDir}${windScale}`;

        weatherTextEl.textContent = desc;
        weatherIconEl.textContent = getWeatherIcon(weather);

      } catch (err) {
        console.error('Weather fetch failed:', err);
        weatherTextEl.textContent = 'å¤©æ°”åŠ è½½å¤±è´¥';
        weatherIconEl.textContent = 'âŒ';
      }
    }

    // åªæœ‰è®¤è¯é€šè¿‡åæ‰åˆå§‹åŒ–åŠ¨ç”»å’Œæ—¶é—´
    function initApp() {
      // === å®æ—¶æ—¶é—´ ===
      function updateTime() {
        const now = new Date();
        document.getElementById('time').textContent =
          now.toLocaleTimeString('zh-CN', { hour12: false });
      }
      setInterval(updateTime, 1000);
      updateTime();

      // === ç²’å­åŠ¨ç”»ï¼ˆé˜³å…‰å°˜åŸƒï¼‰===
      const canvas = document.getElementById('particles');
      const ctx = canvas.getContext('2d');

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      const particles = [];
      const particleCount = Math.min(100, Math.floor((canvas.width * canvas.height) / 6000));

      class Dust {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 2 + 0.5;
          this.speedY = Math.random() * 0.3 + 0.1;
          this.opacity = Math.random() * 0.4 + 0.1;
          this.tilt = (Math.random() - 0.5) * 0.4;
        }
        update() {
          this.y += this.speedY;
          this.x += this.tilt;
          if (this.y > canvas.height || this.x < -10 || this.x > canvas.width + 10) {
            this.reset();
          }
        }
        reset() {
          this.y = -10;
          this.x = Math.random() * canvas.width;
        }
        draw() {
          ctx.fillStyle = `rgba(255, 248, 230, ${this.opacity})`;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      for (let i = 0; i < particleCount; i++) {
        particles.push(new Dust());
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          p.update();
          p.draw();
        });
        requestAnimationFrame(animate);
      }
      animate();
    }

    // ç­‰å¾… DOM åŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>