<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å®¶åº­æ™ºèƒ½ç»ˆç«¯</title>
  <link rel="stylesheet" href="/assets/ui.css">
  <link rel="stylesheet" href="/assets/style.css">
  <!-- é˜²æ­¢æœªç™»å½•ç”¨æˆ·çœ‹åˆ°é¡µé¢å†…å®¹ -->
  <style>
    #auth-guard {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #0a0a0a;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 18px;
    }
    /* åˆå§‹éšè—çœŸå®å†…å®¹ */
    #app-content { display: none; }
  </style>
</head>
<body class="ui">
  <!-- ğŸ”’ è®¤è¯é®ç½©ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
  <div id="auth-guard">
    éªŒè¯ç™»å½•ä¸­ï¼Œè¯·ç¨å€™...
  </div>

  <!-- ğŸ–¼ï¸ çœŸå®é¡µé¢å†…å®¹ï¼ˆåˆå§‹éšè—ï¼‰ -->
  <div id="app-content">
    <div class="bg"></div>
    <div class="overlay"></div>
    <canvas id="particles"></canvas>
    <img class="ui-brand" src="/assets/logo-yymk.svg" alt="YYMK" />

    <div class="container ui-animate-in">
      <div class="time" id="time">--:--</div>
      <div class="temp"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-temp"/></svg><span id="temperature">å®¤æ¸©ï¼š23Â°C</span></div>
      
      <!-- âœ… ä¿®æ”¹ï¼šåŠ¨æ€å¤©æ°”è¡Œ -->
      <div class="weather" id="weather">
        <svg id="weather-icon" class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-weather"/></svg>
        <span id="weather-text">åŠ è½½ä¸­...</span>
      </div>
      
      <!-- 6ä¸ªåŠŸèƒ½å…¥å£ -->
      <div class="buttons">
        <a href="/disk.html" class="btn"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-disk"/></svg><span>ç§äººç½‘ç›˜</span></a>
        <a href="/control.html" class="btn"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-control"/></svg><span>å®¶å±…æ§åˆ¶</span></a>
        <a href="/notes.html" class="btn"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-notes"/></svg><span>å®¶åº­å¤‡å¿˜å½•</span></a>
        <a href="/photos.html" class="btn"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-photos"/></svg><span>å®¶åº­ç›¸å†Œ</span></a>
        <a href="/system.html" class="btn"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-system"/></svg><span>ç³»ç»Ÿæ•°æ®</span></a>
        <a href="/settings.html" class="btn"><svg class="ui-icon-color" aria-hidden="true"><use href="/assets/icons-color.svg#icon-settings"/></svg><span>è®¾ç½®</span></a>
      </div>
    </div>
  </div>

  <!-- ğŸ” ç™»å½•çŠ¶æ€æ£€æµ‹ï¼ˆå…³é”®ï¼šæ”¾åœ¨å†…å®¹ä¹‹åã€åŠ¨ç”»ä¹‹å‰ï¼‰ -->
    <script>
    // === æ¸©æ¹¿åº¦è½®è¯¢ ===
    async function fetchAndRenderTemperature() {
      const tempEl = document.getElementById('temperature');
      try {
        const res = await fetch('/home/temperature');
        if (!res.ok) throw new Error('Network error');

        const data = await res.json();

        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
        if (data.humidity != null && data.temperature != null) {
          const hum = parseFloat(data.humidity).toFixed(1);
          const temp = parseFloat(data.temperature).toFixed(1);
          tempEl.textContent = `å®¤æ¸©ï¼š${temp}Â°C Â· æ¹¿åº¦ï¼š${hum}%`;
        } else if (data.error) {
          tempEl.textContent = `${data.error}`;
        } else {
          tempEl.textContent = 'æ•°æ®å¼‚å¸¸';
        }
      } catch (err) {
        console.error('Temperature fetch failed:', err);
        tempEl.textContent = 'åŠ è½½å¤±è´¥';
      }
    }

    async function fetchAndRenderWeather() {
      const weatherTextEl = document.getElementById('weather-text');
      const weatherIconEl = document.getElementById('weather-icon');
      const weatherIconUse = weatherIconEl ? weatherIconEl.querySelector('use') : null;

      try {
        const res = await fetch('/home/weather');
        if (!res.ok) throw new Error('Network error');

        const data = await res.json();

        if (data.code !== '200') {
          weatherTextEl.textContent = 'å¤©æ°”æ•°æ®å¼‚å¸¸';
          if (weatherIconUse) weatherIconUse.setAttribute('href', '/assets/icons-color.svg#icon-weather');
          return;
        }

        const weather = data.weather || 'æœªçŸ¥';
        const temp = data.temperature || '--';
        const humidity = data.humidity || '--';
        const feelsLike = data.feels_like || '--';
        const windDir = data.wind_dir || '';
        const windScale = data.wind_scale ? `${data.wind_scale}çº§` : '';

        let desc = `${weather} Â· ${temp}Â°C`;
        if (feelsLike !== '--') desc += ` Â· ä½“æ„Ÿ ${feelsLike}Â°C`;
        if (humidity !== '--') desc += ` Â· æ¹¿åº¦ ${humidity}%`;
        if (windDir || windScale) desc += ` Â· ${windDir} ${windScale}`;

        weatherTextEl.textContent = desc;
        if (weatherIconUse) weatherIconUse.setAttribute('href', '/assets/icons-color.svg#icon-weather');

      } catch (err) {
        console.error('Weather fetch failed:', err);
        weatherTextEl.textContent = 'å¤©æ°”åŠ è½½å¤±è´¥';
        if (weatherIconUse) weatherIconUse.setAttribute('href', '/assets/icons-color.svg#icon-weather');
      }
    }

    // === è®¤è¯ & åˆå§‹åŒ– ===
    (async () => {
      try {
        const res = await fetch('/home/check-auth');
        if (res.status === 401) {
          window.location.replace('/login.html');
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch (e) {
          data = {};
        }

        if (data.error && data.error.includes('Unauthorized')) {
          window.location.replace('/login.html');
          return;
        }

        // éšè—é®ç½©ï¼Œæ˜¾ç¤ºå†…å®¹
        document.getElementById('auth-guard').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';

        // âœ… å¯åŠ¨æ¸©æ¹¿åº¦è½®è¯¢ï¼ˆç«‹å³ + æ¯30ç§’ï¼‰
        fetchAndRenderTemperature();
        setInterval(fetchAndRenderTemperature, 30 * 1000);

        // å¯åŠ¨å¤©æ°”è½®è¯¢ï¼ˆç«‹å³ + æ¯5åˆ†é’Ÿï¼‰
        fetchAndRenderWeather();
        setInterval(fetchAndRenderWeather, 5 * 60 * 1000);

        // åˆå§‹åŒ–æ—¶é—´ & ç²’å­åŠ¨ç”»
        initApp();

      } catch (err) {
        window.location.replace('/login.html');
      }
    })();

    // === æ—¶é—´ & ç²’å­åŠ¨ç”»ï¼ˆä¿æŒä¸å˜ï¼‰===
    function initApp() {
      // === å®æ—¶æ—¶é—´ ===
      function updateTime() {
        const now = new Date();
        document.getElementById('time').textContent =
          now.toLocaleTimeString('zh-CN', { hour12: false });
      }
      setInterval(updateTime, 1000);
      updateTime();

      // === ç²’å­åŠ¨ç”»ï¼ˆé˜³å…‰å°˜åŸƒï¼‰===
      const canvas = document.getElementById('particles');
      const ctx = canvas.getContext('2d');

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      const particles = [];
      const particleCount = Math.min(100, Math.floor((canvas.width * canvas.height) / 6000));

      class Dust {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 2 + 0.5;
          this.speedY = Math.random() * 0.3 + 0.1;
          this.opacity = Math.random() * 0.4 + 0.1;
          this.tilt = (Math.random() - 0.5) * 0.4;
        }
        update() {
          this.y += this.speedY;
          this.x += this.tilt;
          if (this.y > canvas.height || this.x < -10 || this.x > canvas.width + 10) {
            this.reset();
          }
        }
        reset() {
          this.y = -10;
          this.x = Math.random() * canvas.width;
        }
        draw() {
          ctx.fillStyle = `rgba(255, 248, 230, ${this.opacity})`;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      for (let i = 0; i < particleCount; i++) {
        particles.push(new Dust());
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          p.update();
          p.draw();
        });
        requestAnimationFrame(animate);
      }
      animate();
    }
  </script>
</body>
</html>
