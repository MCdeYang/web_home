<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç³»ç»Ÿè®¾ç½®</title>
  <link rel="stylesheet" href="/assets/settings.css" />
  <style>
    #publicUrlDisplay {
      margin-top: 10px;
      padding: 8px;
      background: #f0f8ff;
      border-radius: 4px;
      word-break: break-all;
    }
    #publicUrlDisplay a {
      color: #1e90ff;
      text-decoration: none;
    }
    #publicUrlDisplay a:hover {
      text-decoration: underline;
    }
    .hidden {
      display: none !important;
    }

    /* è½¬åœˆåŠ¨ç”»æ ·å¼ */
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .spinner {
      display: inline-block;
      vertical-align: middle;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #1e90ff;
      border-radius: 50%;
      animation: rotate 1s linear infinite;
    }
  </style>
</head>
<body style="background-image: url('/assets/settings.png'); background-size: cover; background-attachment: fixed;">
  <div class="container">
    <h2>ç³»ç»Ÿè®¾ç½®</h2>

    <!-- ç”¨æˆ·å & å¯†ç è¡¨å• -->
    <form id="passwordForm">
      <label for="username">ç”¨æˆ·å:</label>
      <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·åï¼ˆæ”¯æŒä¸­æ–‡ï¼‰" />

      <label for="newPassword">æ–°å¯†ç :</label>
      <input type="password" id="newPassword" name="newPassword" placeholder="æ–°å¯†ç " />

      <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç :</label>
      <input type="password" id="confirmPassword" name="confirmPassword" />

      <button type="submit">ä¿å­˜è®¾ç½®</button>
    </form>

    <!-- å…¬ç½‘ç©¿é€æ§åˆ¶è¡¨å• -->
    <form id="publicForm" style="margin-top: 30px;">
      <label>
        <input type="checkbox" id="publicToggle" />
        å¼€å¯å…¬ç½‘è®¿é—®ï¼ˆå†…ç½‘ç©¿é€ï¼‰
      </label>
      <div id="warning" class="warning hidden">
        âš ï¸ è­¦å‘Šï¼šå¼€å¯åæ‚¨çš„è®¾å¤‡å°†æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œå¯èƒ½è¢«æ”»å‡»ï¼ä»…åœ¨å¿…è¦æ—¶å¼€å¯ï¼Œå¹¶å°½å¿«å…³é—­ã€‚
      </div>

      <!-- å…¬ç½‘URLæ˜¾ç¤ºåŒºåŸŸ -->
      <div id="publicUrlDisplay" class="hidden"></div>

      <!-- Loading æç¤º -->
      <div id="publicLoading" class="hidden" style="margin-top: 10px; color: #1e90ff; text-align: center;">
        <span class="spinner"></span> æ­£åœ¨å¯åŠ¨å…¬ç½‘æœåŠ¡ï¼Œè¯·ç¨å€™...
      </div>

      <button type="submit" id="publicSubmitBtn" style="margin-top: 10px;">ä¿å­˜å…¬ç½‘è®¾ç½®</button>
    </form>

    <a href="/index.html" class="home-button">è¿”å›ä¸»é¡µ</a>
  </div>

  <script>
    const API_BASE = '/home';

    // æ›´æ–°å…¬ç½‘URLæ˜¾ç¤º
    function updatePublicUrlDisplay(publicUrl) {
      const el = document.getElementById('publicUrlDisplay');
      if (publicUrl && publicUrl.startsWith('http')) {
        el.innerHTML = `ğŸŒ å…¬ç½‘åœ°å€ï¼š<a href="${publicUrl}" target="_blank">${publicUrl}</a>`;
        el.classList.remove('hidden');
      } else {
        el.classList.add('hidden');
      }
    }

    // åˆå§‹åŒ–ï¼šåŠ è½½å½“å‰è®¾ç½®
    Promise.all([
      fetch(API_BASE + '/settings/change-password').then(r => r.json()),
      fetch(API_BASE + '/settings/public').then(r => r.json())
    ]).then(([userRes, publicRes]) => {
      const usernameEl = document.getElementById('username');
      usernameEl.value = userRes.username || 'admin';
      usernameEl.dataset.original = userRes.username || 'admin';

      const toggle = document.getElementById('publicToggle');
      toggle.checked = publicRes.enabled;
      if (publicRes.enabled) {
        document.getElementById('warning').classList.remove('hidden');
      }
      updatePublicUrlDisplay(publicRes.public_url);
    }).catch(err => {
      console.error('åŠ è½½å¤±è´¥:', err);
      alert('æ— æ³•åŠ è½½è®¾ç½®ï¼Œè¯·ç¡®ä¿æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚');
    });

    // å…¬ç½‘å¼€å…³å˜åŒ–æ—¶æ˜¾ç¤ºè­¦å‘Š
    document.getElementById('publicToggle').addEventListener('change', function () {
      const warning = document.getElementById('warning');
      if (this.checked) {
        warning.classList.remove('hidden');
        alert('âš ï¸ å®‰å…¨è­¦å‘Š\n\næ‚¨å³å°†å¼€å¯å…¬ç½‘è®¿é—®ã€‚è¿™æ„å‘³ç€ä»»ä½•äººéƒ½å¯èƒ½è®¿é—®æ‚¨çš„è®¾å¤‡ï¼\n\nè¯·ç¡®ä¿:å·²è®¾ç½®å¼ºå¯†ç \n');
      } else {
        warning.classList.add('hidden');
        updatePublicUrlDisplay('');
      }
    });

    // æäº¤ç”¨æˆ·å/å¯†ç 
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const usernameEl = document.getElementById('username');
      const originalUsername = usernameEl.dataset.original || 'admin';
      let username = usernameEl.value.trim();
      const np = document.getElementById('newPassword').value;
      const cp = document.getElementById('confirmPassword').value;

      if (!username) return alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
      if (username.length < 2 || username.length > 32) return alert('ç”¨æˆ·åé•¿åº¦éœ€ä¸º 2ï½32 ä¸ªå­—ç¬¦ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰ï¼');

      const isUsernameChanged = username !== originalUsername;
      const isPasswordEmpty = !np;

      if (isUsernameChanged && isPasswordEmpty) {
        const confirmed = confirm(
          'âš ï¸ æ‚¨æ­£åœ¨ä¿®æ”¹ç”¨æˆ·åï¼Œä½†æœªè®¾ç½®æ–°å¯†ç ã€‚\n' +
          'ä¸ºå®‰å…¨èµ·è§ï¼Œå»ºè®®åŒæ—¶æ›´æ–°å¯†ç ã€‚\n\n' +
          'è¯·åŒæ—¶ä¿®æ”¹å¯†ç ï¼Œæˆ–ç‚¹å‡»â€œå–æ¶ˆâ€è¿”å›ã€‚'
        );
        if (!confirmed) return;
      }

      if (np) {
        if (np !== cp) return alert('å¯†ç ä¸ä¸€è‡´ï¼');
        if (np.length < 4) return alert('å¯†ç è‡³å°‘4ä½ï¼');
      }

      try {
        const res = await fetch(API_BASE + '/settings/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=utf-8' },
          body: JSON.stringify({
            username: username,
            password: np || ""
          })
        });

        if (res.ok) {
          alert('è®¾ç½®å·²æ›´æ–°ï¼');
          usernameEl.dataset.original = username;
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
        } else {
          const text = await res.text();
          alert('æ›´æ–°å¤±è´¥ï¼š' + (text || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (err) {
        alert('è¯·æ±‚å¤±è´¥ï¼š' + err.message);
      }
    });

    // æäº¤å…¬ç½‘è®¾ç½®ï¼ˆå¸¦ loadingï¼‰
    document.getElementById('publicForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const toggle = document.getElementById('publicToggle');
      const btn = document.getElementById('publicSubmitBtn');
      const loading = document.getElementById('publicLoading');
      const enabled = toggle.checked;

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      btn.disabled = true;
      loading.classList.remove('hidden');

      try {
        const res = await fetch(API_BASE + '/settings/public', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });

        if (res.ok) {
          const data = await res.json();
          alert(`å…¬ç½‘è®¿é—®å·²${enabled ? 'å¼€å¯' : 'å…³é—­'}ã€‚`);
          updatePublicUrlDisplay(enabled ? data.public_url : '');
        } else {
          const text = await res.text();
          alert('è®¾ç½®å¤±è´¥ï¼š' + (text || 'æœªçŸ¥é”™è¯¯'));
          updatePublicUrlDisplay('');
        }
      } catch (err) {
        alert('è¯·æ±‚å¤±è´¥ï¼š' + err.message);
        updatePublicUrlDisplay('');
      } finally {
        // æ¢å¤æŒ‰é’®å’Œéšè— loading
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });
  </script>
</body>
</html>