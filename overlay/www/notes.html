<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å®¶åº­å¤‡å¿˜å½•</title>
  <link rel="stylesheet" href="assets/notes.css" />
</head>
<body>
  <!-- è¿”å›ä¸»é¡µæŒ‰é’® -->
  <div class="header">
    <a href="index.html" class="home-btn">ğŸ  è¿”å›ä¸»é¡µ</a>
    <h1>å®¶åº­å¤‡å¿˜å½•</h1>
  </div>

  <main class="container">
    <!-- æˆå‘˜ç®¡ç†åŒº -->
    <section class="card">
      <h2>å®¶åº­æˆå‘˜</h2>
      <div id="members-list"></div>
      <button id="add-member-btn" class="btn-primary">+ æ·»åŠ æˆå‘˜</button>
    </section>

    <!-- æ·»åŠ ä»»åŠ¡åŒº -->
    <section class="card">
      <h2>åˆ›å»ºæ–°ä»»åŠ¡</h2>
      <form id="task-form">
        <label>
          ç›®æ ‡æˆå‘˜:
          <select id="target-member" required></select>
        </label>
        <label>
          äº‹åŠ¡å†…å®¹:
          <input type="text" id="task-title" placeholder="ä¾‹å¦‚ï¼šä¹°ç‰›å¥¶" required />
        </label>
        <label>
          æé†’æ—¶é—´:
          <input type="datetime-local" id="task-due" required />
        </label>
        <button type="submit" class="btn-success">æ·»åŠ ä»»åŠ¡</button>
      </form>
    </section>

    <!-- æˆ‘çš„ä»»åŠ¡ -->
    <section class="card">
      <h2>å¾…åŠäº‹åŠ¡</h2>
      <div id="my-tasks-list">
        <p>åŠ è½½ä¸­...</p>
      </div>
    </section>
  </main>

  <script>
    // ======================
    // å·¥å…·å‡½æ•°
    // ======================
    function formatDateForInput(dateStr) {
      // å°† "2026-01-25 10:30" è½¬ä¸º "2026-01-25T10:30"
      return dateStr.replace(' ', 'T');
    }

    function showMsg(msg, type = 'info') {
      alert(msg); // ç®€åŒ–ç‰ˆï¼Œå¯æ›¿æ¢ä¸º toast
    }

    // ======================
    // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
    // ======================
    async function renderMembers() {
      try {
        const res = await fetch('/home/family/members');
        if (!res.ok) throw new Error('è·å–æˆå‘˜å¤±è´¥');
        const data = await res.json();

        const listEl = document.getElementById('members-list');
        const selectEl = document.getElementById('target-member');

        listEl.innerHTML = '';
        selectEl.innerHTML = '';

        data.members.forEach(member => {
          // æˆå‘˜å¡ç‰‡
          const div = document.createElement('div');
          div.className = 'member-item';
          div.innerHTML = `
            <strong> ${member.name}</strong><br>
            ç”Ÿæ—¥:  ${member.birthday}<br>
            å¾®ä¿¡ID:  ${member.wechat_id.substring(0,6)}... 
          `;
          listEl.appendChild(div);

          // ä¸‹æ‹‰é€‰é¡¹
          const opt = document.createElement('option');
          opt.value = member.name;
          opt.textContent = member.name;
          selectEl.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        document.getElementById('members-list').innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥</p>';
      }
    }

    // ======================
    // æ¸²æŸ“æˆ‘çš„ä»»åŠ¡ï¼ˆä»…æ­¤å‡½æ•°è¢«ä¿®æ”¹ï¼‰
    // ======================
    async function renderMyTasks() {
      try {
        const res = await fetch('/home/family/members');
        if (!res.ok) throw new Error('è·å–æˆå‘˜å¤±è´¥');
        const data = await res.json();

        const container = document.getElementById('my-tasks-list');
        let allTasks = [];

        if (data.members && Array.isArray(data.members)) {
          data.members.forEach(member => {
            if (member.tasks && Array.isArray(member.tasks)) {
              member.tasks.forEach(task => {
                // ç®€å•åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼ˆå‰ç«¯åˆ¤æ–­ï¼Œé¿å…ä¾èµ–åç«¯æ—¶é—´é€»è¾‘ï¼‰
                const now = new Date();
                const due = new Date(task.due_date.replace(' ', 'T')); // è½¬ä¸º ISO æ ¼å¼
                if (due > now) {
                  // å…³é”®ï¼šè®°å½•æˆå‘˜åï¼Œè€Œä¸æ˜¯ç”¨ task.creator
                  allTasks.push({
                    title: task.title,
                    due_date: task.due_date,
                    owner: member.name
                  });
                }
              });
            }
          });
        }

        if (allTasks.length === 0) {
          container.innerHTML = '<p>æš‚æ— å¾…åŠä»»åŠ¡</p>';
          return;
        }

        let html = '';
        allTasks.forEach(task => {
          html += `
            <div class="task-item">
              <strong>å¾…åŠäº‹åŠ¡ï¼š${task.title}</strong><br>
              <small>å‘é€æ—¶é—´:  ${task.due_date} | æˆå‘˜:  ${task.owner}</small>
            </div>
          `;
        });
        container.innerHTML = html;
      } catch (err) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', err);
        document.getElementById('my-tasks-list').innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥:  $ {err.message}</p>`;
      }
    }

    // ======================
    // äº‹ä»¶ç»‘å®š
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      // åŠ è½½æ•°æ®
      renderMembers();
      renderMyTasks();

      // æ·»åŠ æˆå‘˜ï¼ˆç®€åŒ–ï¼šå¼¹çª—è¾“å…¥ï¼‰
      document.getElementById('add-member-btn').addEventListener('click', () => {
        const name = prompt('å§“å:');
        const wechat = prompt('å¾®ä¿¡æ¨é€ID (Serveré…±SCKEY):');
        const birthday = prompt('ç”Ÿæ—¥ (MM-DD, å¦‚ 06-01):');
        if (!name || !wechat || !birthday) return;

        fetch('/home/family/members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, wechat_id: wechat, birthday })
        }).then(res => {
          if (res.ok) {
            showMsg('æˆå‘˜æ·»åŠ æˆåŠŸ');
            renderMembers();
          } else {
            showMsg('æ·»åŠ å¤±è´¥');
          }
        });
      });

      // æ·»åŠ ä»»åŠ¡
      document.getElementById('task-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const target = document.getElementById('target-member').value;
        const title = document.getElementById('task-title').value;
        const due = document.getElementById('task-due').value;

        const res = await fetch('/home/family/task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            target_member: target,
            title: title,
            due_date: due.replace('T', ' ') // è½¬å› "YYYY-MM-DD HH:MM"
          })
        });

        if (res.ok) {
          showMsg('ä»»åŠ¡å·²æ·»åŠ ');
          document.getElementById('task-form').reset();
          renderMyTasks(); // åˆ·æ–°ï¼ˆå¦‚æœè‡ªå·±æ˜¯ç›®æ ‡ï¼‰
        } else {
          showMsg('æ·»åŠ å¤±è´¥');
        }
      });
    });
  </script>
</body>
</html>