<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘çš„ç§äººç½‘ç›˜</title>
  <link rel="stylesheet" href="/assets/disk.css">
</head>
<body>
  <div class="header">
    <div class="path-display" id="current-path">/</div>
    <div class="controls">
      <button class="home-btn" id="home">ğŸ  è¿”å›é¦–é¡µ</button>
      <button class="refresh-btn" id="refresh">ğŸ”„ åˆ·æ–°</button>
      <button class="upload-btn" id="upload-trigger">ä¸Šä¼ æ–‡ä»¶</button>
      <input type="file" id="file-upload" multiple />
      <button id="new-folder">æ–°å»ºæ–‡ä»¶å¤¹</button>
    </div>
  </div>

  <div class="file-list" id="file-list"></div>
  <div class="toast" id="toast"></div>

  <script>
    let currentPath = '/';

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.backgroundColor = isError ? 'rgba(255,0,0,0.85)' : 'rgba(0,0,0,0.85)';
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== ä¿®å¤åçš„é‡å‘½ååŠŸèƒ½ =====
    async function renameItem(oldName) {
      const newName = prompt('è¯·è¾“å…¥æ–°åç§°ï¼š', oldName);
      if (!newName) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

      const trimmed = newName.trim();
      if (trimmed === '') {
        showToast('åç§°ä¸èƒ½ä¸ºç©º', true);
        return;
      }
      if (trimmed === oldName) {
        showToast('æ–°åç§°ä¸èƒ½ä¸åŸåç§°ç›¸åŒ', true);
        return;
      }

      try {
        const res = await fetch('/home/disk/rename', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            path: currentPath,
            old_name: oldName,
            new_name: trimmed
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || 'é‡å‘½åå¤±è´¥');
        }

        showToast('é‡å‘½åæˆåŠŸ');
        loadCurrentDir(); // åˆ·æ–°å½“å‰ç›®å½•
      } catch (err) {
        showToast('é”™è¯¯: ' + err.message, true);
      }
    }
    // ===== ç»“æŸ =====

    function isImageFile(name) {
      const ext = name.split('.').pop().toLowerCase();
      return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext);
    }

    function isPreviewableInline(name) {
      const ext = name.split('.').pop().toLowerCase();
      return [
        'pdf', 'txt', 'mp4', 'webm', 'ogg', 'mp3', 'wav', 'flac'
      ].includes(ext);
    }

    function getFileIcon(name, isDir) {
      if (isDir) return 'ğŸ“';
      
      const ext = name.split('.').pop().toLowerCase();
      const iconMap = {
        'pdf': 'ğŸ“˜', 'doc': 'ğŸ“˜', 'docx': 'ğŸ“˜',
        'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'csv': 'ğŸ“Š',
        'ppt': 'ğŸ“½ï¸', 'pptx': 'ğŸ“½ï¸',
        'txt': 'ğŸ“„', 'md': 'ğŸ“„', 'log': 'ğŸ“„', 'rtf': 'ğŸ“„',
        'js': 'ğŸ“œ', 'ts': 'ğŸ“œ', 'jsx': 'âš›ï¸', 'tsx': 'âš›ï¸',
        'py': 'ğŸ', 'java': 'â˜•', 'c': 'âš™ï¸', 'cpp': 'âš™ï¸', 'h': 'HeaderCode',
        'html': 'ğŸŒ', 'htm': 'ğŸŒ', 'css': 'ğŸ¨', 'scss': 'ğŸ¨',
        'json': 'ğŸ”§', 'xml': 'ğŸ“', 'yaml': 'ğŸ“‹', 'yml': 'ğŸ“‹',
        'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ¬',
        'bmp': 'ğŸ–¼ï¸', 'svg': 'ğŸ“', 'webp': 'ğŸ–¼ï¸', 'ico': 'ğŸ–¼ï¸',
        'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'ogg': 'ğŸµ', 'flac': 'ğŸµ',
        'mp4': 'ğŸ¥', 'avi': 'ğŸ¥', 'mkv': 'ğŸ¥', 'mov': 'ğŸ¥', 'wmv': 'ğŸ¥',
        'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦', 'tar': 'ğŸ“¦', 'gz': 'ğŸ“¦',
        'exe': 'âš™ï¸', 'msi': 'âš™ï¸', 'bat': 'ğŸ’»', 'sh': 'ğŸ§', 'app': 'ğŸ',
        'iso': 'ğŸ’¿', 'dmg': 'ğŸ', 'apk': 'ğŸ“±'
      };
      
      return iconMap[ext] || 'ğŸ“„';
    }

    async function checkAuth() {
      try {
        const res = await fetch('/home/check-auth', { credentials: 'include' });
        if (!res.ok) {
          window.location.href = '/login.html';
          return false;
        }
        return true;
      } catch (err) {
        console.error('Auth check failed:', err);
        window.location.href = '/login.html';
        return false;
      }
    }

    async function uploadFile(file, targetPath) {
      if (targetPath === '') targetPath = '/';
      if (!targetPath.startsWith('/')) targetPath = '/' + targetPath;

      const formData = new FormData();
      formData.append('file', file);

      const url = `/home/disk/upload?path=${encodeURIComponent(targetPath)}`;
      const res = await fetch(url, {
        method: 'POST',
        credentials: 'include',
        body: formData
      });

      if (!res.ok) {
        let errMsg = `HTTP ${res.status}`;
        try {
          const json = await res.json();
          errMsg += ': ' + (json.message || json.error || 'Upload failed');
        } catch (e) {
          const text = await res.text().catch(() => '');
          if (text) errMsg += ': ' + text.substring(0, 100);
        }
        throw new Error(errMsg);
      }
    }

    async function createFolder(name) {
      const params = new URLSearchParams();
      params.append('name', name.trim());
      if (currentPath !== '/') {
        const relPath = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
        params.append('path', relPath);
      }

      const res = await fetch('/home/disk/mkdir', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || 'åˆ›å»ºå¤±è´¥');
      }
    }

    async function deleteItem(name) {
      const fullPath = currentPath === '/' ? `/${name}` : `${currentPath}/${name}`;
      const url = `/home/disk/delete?path=${encodeURIComponent(fullPath)}`;
      const res = await fetch(url, {
        method: 'DELETE',
        credentials: 'include'
      });
      if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
    }

    function openFile(name) {
      const fullPath = currentPath === '/' ? `/${name}` : `${currentPath}/${name}`;
      const url = `/home/disk/download?path=${encodeURIComponent(fullPath)}`;

      if (isImageFile(name)) {
        previewImage(url, name);
      } else if (isPreviewableInline(name)) {
        window.open(url, '_blank');
      } else {
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }

    function previewImage(imageUrl, filename) {
      const modal = document.createElement('div');
      modal.className = 'preview-modal';

      const container = document.createElement('div');
      container.className = 'preview-container';

      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = filename;

      const caption = document.createElement('div');
      caption.className = 'preview-caption';
      caption.textContent = filename;

      img.onload = () => img.classList.add('loaded');
      img.onerror = () => {
        img.src = '';
        img.alt = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥';
        img.style.color = 'white';
        img.style.fontSize = '18px';
        img.classList.add('loaded');
      };

      container.appendChild(img);
      container.appendChild(caption);
      modal.appendChild(container);

      modal.onclick = () => document.body.removeChild(modal);
      img.onclick = (e) => e.stopPropagation();

      document.body.appendChild(modal);
    }

    async function loadDir(path) {
      const url = `/home/disk/list?path=${encodeURIComponent(path)}`;
      const res = await fetch(url, { credentials: 'include' });
      if (!res.ok) throw new Error('åŠ è½½ç›®å½•å¤±è´¥');
      const data = await res.json();
      return data.files || [];
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp * 1000);
      const now = new Date();
      const diff = now - date;
      if (diff < 24 * 60 * 60 * 1000) {
        return date.toLocaleTimeString('zh-CN');
      }
      return date.toLocaleDateString('zh-CN');
    }

    async function renderFiles(files) {
      const list = document.getElementById('file-list');
      list.innerHTML = '';

      if (currentPath !== '/') {
        const upItem = document.createElement('div');
        upItem.className = 'file-item dir';
        upItem.innerHTML = `
          <div class="file-icon">ğŸ“</div>
          <div class="file-info">
            <div class="file-name">..</div>
          </div>
        `;
        upItem.onclick = () => {
          const parts = currentPath.split('/').filter(p => p);
          parts.pop();
          currentPath = parts.length ? '/' + parts.join('/') : '/';
          loadCurrentDir();
        };
        list.appendChild(upItem);
      }

      files.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = `file-item ${file.is_dir ? 'dir' : ''}`;
        item.style.setProperty('--index', index);

        const icon = getFileIcon(file.name, file.is_dir);
        const isImage = isImageFile(file.name);
        const isPreviewable = isPreviewableInline(file.name);
        const actionText = (isImage || isPreviewable) ? 'é¢„è§ˆ' : 'ä¸‹è½½';

        // ===== ä¿®æ”¹ï¼šå¢åŠ é‡å‘½åæŒ‰é’® =====
        let actionBtn = '';

        if (!file.is_dir) {
          actionBtn = `<button class="action-btn" onclick="event.stopPropagation();openFile('${file.name}')">${actionText}</button>`;
        }

        // æ‰€æœ‰é¡¹éƒ½æ”¯æŒé‡å‘½å
        actionBtn += '<button class="action-btn rename-btn">é‡å‘½å</button>';
        actionBtn += '<button class="action-btn delete-btn">åˆ é™¤</button>';
        // ===== ç»“æŸä¿®æ”¹ =====

        item.innerHTML = `
          <div class="file-icon">${icon}</div>
          <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-meta">
              ${file.is_dir ? 'æ–‡ä»¶å¤¹' : formatBytes(file.size)}
              â€¢ ${formatDate(file.mtime)}
            </div>
          </div>
          <div>${file.is_dir ? '<button class="action-btn delete-btn">åˆ é™¤</button>' : actionBtn}</div>
        `;

        if (file.is_dir) {
          item.onclick = () => {
            currentPath = currentPath === '/' 
              ? `/${file.name}` 
              : `${currentPath}/${file.name}`;
            loadCurrentDir();
          };
        } else {
          item.onclick = () => openFile(file.name);
        }

        // ===== æ–°å¢ï¼šç»‘å®šé‡å‘½åäº‹ä»¶ =====
        const renameBtn = item.querySelector('.rename-btn');
        if (renameBtn) {
          renameBtn.onclick = (e) => {
            e.stopPropagation();
            renameItem(file.name);
          };
        }
        // ===== ç»“æŸæ–°å¢ =====

        item.querySelector('.delete-btn').onclick = async (e) => {
          e.stopPropagation();
          if (confirm(`ç¡®å®šåˆ é™¤ "${file.name}"ï¼Ÿ`)) {
            try {
              await deleteItem(file.name);
              showToast('å·²åˆ é™¤');
              loadCurrentDir();
            } catch (err) {
              showToast('åˆ é™¤å¤±è´¥: ' + err.message, true);
            }
          }
        };

        list.appendChild(item);
      });
    }

    async function loadCurrentDir() {
      document.getElementById('current-path').textContent = currentPath;
      try {
        const files = await loadDir(currentPath);
        renderFiles(files);
      } catch (err) {
        showToast('åŠ è½½å¤±è´¥: ' + err.message, true);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await checkAuth()) return;

      document.getElementById('home').onclick = () => {
        window.location.href = '/index.html';
      };

      document.getElementById('refresh').onclick = () => {
        loadCurrentDir();
      };

      document.getElementById('upload-trigger').onclick = () => {
        document.getElementById('file-upload').click();
      };

      document.getElementById('file-upload').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files.length) return;

        for (let file of files) {
          try {
            await uploadFile(file, currentPath);
          } catch (err) {
            showToast(`ä¸Šä¼  "${file.name}" å¤±è´¥: ${err.message}`, true);
            return;
          }
        }
        showToast('ä¸Šä¼ å®Œæˆ');
        loadCurrentDir();
        e.target.value = '';
      });

      document.getElementById('new-folder').onclick = async () => {
        const name = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼š');
        if (!name || name.trim() === '') return;
        try {
          await createFolder(name);
          showToast('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
          loadCurrentDir();
        } catch (err) {
          showToast('åˆ›å»ºå¤±è´¥: ' + err.message, true);
        }
      };

      loadCurrentDir();
    });

    window.openFile = openFile;
    window.renameItem = renameItem;
  </script>
</body>
</html>