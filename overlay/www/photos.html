<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å®¶åº­ç›¸å†Œ</title>
  <link rel="stylesheet" href="./assets/photos.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ“¸ å®¶åº­ç›¸å†Œ</h1>

    <div class="controls">
      <button class="btn home-btn" onclick="window.location.href='index.html'">ğŸ  è¿”å›ä¸»é¡µ</button>
      <button class="btn refresh-btn" onclick="loadPhotos()">ğŸ”„ åˆ·æ–°ç›¸å†Œ</button>
    </div>

    <div class="upload-area">
      <input type="file" id="file-input" accept="image/*" multiple />
      <button class="btn upload-btn" onclick="uploadFiles()">ğŸ“¤ ä¸Šä¼ ç…§ç‰‡</button>
    </div>

    <div class="gallery" id="gallery">
      <p class="loading">åŠ è½½ä¸­...</p>
    </div>
  </div>

  <script>
    let currentPhotos = [];
    const photoNotes = {};

    async function loadPhotos() {
      try {
        const listRes = await fetch('/home/photos', { method: 'GET' });
        if (!listRes.ok) throw new Error('åŠ è½½å¤±è´¥');
        currentPhotos = await listRes.json();

        const notePromises = currentPhotos.map(name =>
          fetch(`/home/photo/note?name=${encodeURIComponent(name)}`)
            .then(r => r.ok ? r.text() : '')
            .catch(() => '')
        );
        const notes = await Promise.all(notePromises);
        currentPhotos.forEach((name, i) => {
          photoNotes[name] = notes[i];
        });

        renderGallery();
      } catch (err) {
        console.error(err);
        document.getElementById('gallery').innerHTML = '<p class="error">âŒ åŠ è½½å¤±è´¥</p>';
      }
    }

    function renderGallery() {
      const gallery = document.getElementById('gallery');
      if (currentPhotos.length === 0) {
        gallery.innerHTML = '<p class="empty">æš‚æ— ç…§ç‰‡ï¼Œå¿«ä¸Šä¼ ä¸€å¼ å§ï¼</p>';
        return;
      }

      gallery.innerHTML = '';
      currentPhotos.forEach(filename => {
        const note = photoNotes[filename] || '';
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
          <div class="photo-inner">
            <div class="photo-front">
              <img src="/home/photo?name=${encodeURIComponent(filename)}&t=${Date.now()}" 
                  alt="${filename}" 
                  loading="lazy"
                  onerror="this.closest('.photo-card').classList.add('broken')">
            </div>
            <div class="photo-back">
              <div class="filename"> ${filename}</div>
              ${note ? `<div class="photo-note"> ${note}</div>` : ''}
              <div class="back-buttons">
                <button class="edit-btn" onclick="event.stopPropagation(); editNote('${filename.replace(/'/g, "\\\\'")}');">âœï¸ ç¼–è¾‘</button>
                <button class="delete-btn" onclick="event.stopPropagation(); deletePhoto('${filename.replace(/'/g, "\\\\'")}');">ğŸ—‘ï¸ åˆ é™¤</button>
              </div>
            </div>
          </div>
        `;
        gallery.appendChild(card);
      });
    }

    function editNote(filename) {
      const current = photoNotes[filename] || '';
      const input = prompt('è¯·è¾“å…¥ç…§ç‰‡æ³¨é‡Šï¼š', current);
      if (input !== null) saveNote(filename, input);
    }

    async function saveNote(filename, note) {
      try {
        const res = await fetch('/home/photo/note', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename, note })
        });
        if (res.ok) {
          photoNotes[filename] = note;
          renderGallery();
        } else {
          alert('âŒ ä¿å­˜å¤±è´¥');
        }
      } catch (err) {
        alert('ç½‘ç»œé”™è¯¯');
      }
    }

    async function uploadFiles() {
      const input = document.getElementById('file-input');
      const files = Array.from(input.files).filter(file => file.type.startsWith('image/'));
      if (files.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€å¼ å›¾ç‰‡');
        return;
      }

      const formData = new FormData();
      files.forEach(file => formData.append('photo', file, file.name));

      try {
        const res = await fetch('/home/photos', { method: 'POST', body: formData });
        if (res.ok) {
          alert('âœ… ä¸Šä¼ æˆåŠŸï¼');
          input.value = '';
          loadPhotos();
        } else {
          const err = await res.json().catch(() => ({}));
          alert(`âŒ ä¸Šä¼ å¤±è´¥: ${err.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
      } catch (err) {
        alert('ç½‘ç»œé”™è¯¯');
      }
    }

    async function deletePhoto(filename) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${filename}" å—ï¼Ÿ`)) return;
      try {
        const res = await fetch('/home/photos', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });
        if (res.ok) loadPhotos();
        else alert('åˆ é™¤å¤±è´¥');
      } catch (err) {
        alert('ç½‘ç»œé”™è¯¯');
      }
    }

    document.addEventListener('DOMContentLoaded', loadPhotos);
  </script>
</body>
</html>